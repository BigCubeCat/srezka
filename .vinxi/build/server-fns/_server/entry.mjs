import{fromJSON as I,crossSerializeStream as Y,getCrossReferenceHeader as Z}from"seroval";import{CustomEventPlugin as v,DOMExceptionPlugin as $,EventPlugin as q,FormDataPlugin as T,HeadersPlugin as H,ReadableStreamPlugin as E,RequestPlugin as k,ResponsePlugin as C,URLSearchParamsPlugin as x,URLPlugin as A}from"seroval-plugins/web";import{lazy as ee,createComponent as te,sharedConfig as X}from"solid-js";import{ssrElement as g,escape as U,mergeProps as ne,ssr as se,renderToString as re}from"solid-js/web";import{provideRequestEvent as D}from"solid-js/web/storage";import{H3Event as P,setHeader as oe,appendResponseHeader as ae,getRequestIP as ie,parseCookies as ce,getResponseStatus as ue,getResponseStatusText as le,getCookie as de,setCookie as fe,getResponseHeader as pe,setResponseHeader as he,removeResponseHeader as ge,getResponseHeaders as me,getRequestURL as ye,getRequestWebStream as Re,setResponseStatus as Se,eventHandler as we}from"h3";import{getContext as be}from"unctx";import{AsyncLocalStorage as ve}from"node:async_hooks";import{createRouter as $e}from"radix3";function qe(e){let n;const t=J(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(t,{...r,body:e.node.req.body}):new Request(t,{...r,get body(){return n||(n=Fe(e),n)}})}function Te(e){return e.web??={request:qe(e),url:J(e)},e.web.request}function He(){return _e()}const z=Symbol("$HTTPEvent");function Ee(e){return typeof e=="object"&&(e instanceof P||e?.[z]instanceof P||e?.__is_event__===!0)}function u(e){return function(...n){let t=n[0];if(Ee(t))n[0]=t instanceof P||t.__is_event__?t:t[z];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(t=He(),!t)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");n.unshift(t)}return e(...n)}}const J=u(ye),ke=u(ie),R=u(Se),_=u(ue),Ce=u(le),m=u(me),j=u(pe),xe=u(he),G=u(ae),Ae=u(ce),Pe=u(de),Le=u(fe),y=u(oe),Fe=u(Re),Oe=u(ge),Ie=u(Te);function Ue(){return be("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:ve})}function _e(){return Ue().use().event}const S="Invariant Violation",{setPrototypeOf:je=function(e,n){return e.__proto__=n,e}}=Object;class L extends Error{framesToPop=1;name=S;constructor(n=S){super(typeof n=="number"?`${S}: ${n} (see https://github.com/apollographql/invariant-packages)`:n),je(this,L.prototype)}}function Me(e,n){if(!e)throw new L(n)}const w="solidFetchEvent";function We(e){return{request:Ie(e),response:De(e),clientAddress:ke(e),locals:{},nativeEvent:e}}function Ne(e){return{...e}}function Be(e){if(!e.context[w]){const n=We(e);e.context[w]=n}return e.context[w]}function M(e,n){for(const[t,r]of n.entries())G(e,t,r)}class Xe{event;constructor(n){this.event=n}get(n){const t=j(this.event,n);return Array.isArray(t)?t.join(", "):t||null}has(n){return this.get(n)!==void 0}set(n,t){return xe(this.event,n,t)}delete(n){return Oe(this.event,n)}append(n,t){G(this.event,n,t)}getSetCookie(){const n=j(this.event,"Set-Cookie");return Array.isArray(n)?n:[n]}forEach(n){return Object.entries(m(this.event)).forEach(([t,r])=>n(Array.isArray(r)?r.join(", "):r,t,this))}entries(){return Object.entries(m(this.event)).map(([n,t])=>[n,Array.isArray(t)?t.join(", "):t])[Symbol.iterator]()}keys(){return Object.keys(m(this.event))[Symbol.iterator]()}values(){return Object.values(m(this.event)).map(n=>Array.isArray(n)?n.join(", "):n)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function De(e){return{get status(){return _(e)},set status(n){R(e,n)},get statusText(){return Ce(e)},set statusText(n){R(e,_(e),n)},headers:new Xe(e)}}const V=[],ze=Je(V.filter(e=>e.page));function Je(e){function n(t,r,o,a){const i=Object.values(t).find(c=>o.startsWith(c.id+"/"));return i?(n(i.children||(i.children=[]),r,o.slice(i.id.length)),t):(t.push({...r,id:o,path:o.replace(/\/\([^)/]+\)/g,"").replace(/\([^)/]+\)/g,"")}),t)}return e.sort((t,r)=>t.path.length-r.path.length).reduce((t,r)=>n(t,r,r.path,r.path),[])}function Ge(e){return e.$HEAD||e.$GET||e.$POST||e.$PUT||e.$PATCH||e.$DELETE}$e({routes:V.reduce((e,n)=>{if(!Ge(n))return e;let t=n.path.replace(/\/\([^)/]+\)/g,"").replace(/\([^)/]+\)/g,"").replace(/\*([^/]*)/g,(r,o)=>`**:${o}`).split("/").map(r=>r.startsWith(":")||r.startsWith("*")?r:encodeURIComponent(r)).join("/");if(/:[^/]*\?/g.test(t))throw new Error(`Optional parameters are not supported in API routes: ${t}`);if(e[t])throw new Error(`Duplicate API routes for "${t}" found at "${e[t].route.path}" and "${n.path}"`);return e[t]={route:n},e},{})});function Ve(e){e.forEach(n=>{if(!n.attrs.href)return;let t=document.head.querySelector(`link[href="${n.attrs.href}"]`);t||(t=document.createElement("link"),t.setAttribute("rel","preload"),t.setAttribute("as","style"),t.setAttribute("href",n.attrs.href),document.head.appendChild(t))})}var Ke=" ";const Qe={style:e=>g("style",e.attrs,()=>U(e.children),!0),link:e=>g("link",e.attrs,void 0,!0),script:e=>e.attrs.src?g("script",ne(()=>e.attrs,{get id(){return e.key}}),()=>se(Ke),!0):null,noscript:e=>g("noscript",e.attrs,()=>U(e.children),!0)};function Ye(e,n){let{tag:t,attrs:{key:r,...o}={key:void 0},children:a}=e;return Qe[t]({attrs:{...o,nonce:n},key:r,children:a})}function Ze(e,n,t,r="default"){return ee(async()=>{{const a=(await e.import())[r],c=(await n.inputs?.[e.src].assets()).filter(p=>p.tag==="style"||p.attrs.rel==="stylesheet");return typeof window<"u"&&Ve(c),{default:p=>[...c.map(f=>Ye(f)),te(a,p)]}}})}function et(){function e(t){return{...t,...t.$$route?t.$$route.require().route:void 0,info:{...t.$$route?t.$$route.require().route.info:{},filesystem:!0},component:t.$component&&Ze(t.$component,globalThis.MANIFEST.client,globalThis.MANIFEST.ssr),children:t.children?t.children.map(e):void 0}}return ze.map(e)}function tt(e){const n=Pe(e.nativeEvent,"flash");if(n)try{let t=JSON.parse(n);if(!t||!t.result)return;const r=[...t.input.slice(0,-1),new Map(t.input[t.input.length-1])],o=t.error?new Error(t.result):t.result;return{input:r,url:t.url,pending:!1,result:t.thrown?void 0:o,error:t.thrown?o:void 0}}catch(t){console.error(t)}finally{Le(e.nativeEvent,"flash","",{maxAge:0})}}async function nt(e){const n=globalThis.MANIFEST.client;return globalThis.MANIFEST.ssr,e.response.headers.set("Content-Type","text/html"),Object.assign(e,{manifest:await n.json(),assets:[...await n.inputs[n.handler].assets()],router:{submission:tt(e)},routes:et(),complete:!1,$islands:new Set})}const st=new Set([301,302,303,307,308]);function rt(e){return e.status&&st.has(e.status)?e.status:302}function ot(e){const n=new TextEncoder().encode(e),t=n.length,r=t.toString(16),o="00000000".substring(0,8-r.length)+r,a=new TextEncoder().encode(`;0x${o};`),i=new Uint8Array(12+t);return i.set(a),i.set(n,12),i}function W(e,n){return new ReadableStream({start(t){Y(n,{scopeId:e,plugins:[v,$,q,T,H,E,k,C,x,A],onSerialize(r,o){t.enqueue(ot(o?`(${Z(e)},${r})`:r))},onDone(){t.close()},onError(r){t.error(r)}})}})}async function at(e){const n=Be(e),t=n.request,r=t.headers.get("X-Server-Id"),o=t.headers.get("X-Server-Instance"),a=t.headers.has("X-Single-Flight"),i=new URL(t.url);let c,d;if(r)Me(typeof r=="string","Invalid server function"),[c,d]=r.split("#");else if(c=i.searchParams.get("id"),d=i.searchParams.get("name"),!c||!d)throw new Error("Invalid request");const p=(await globalThis.MANIFEST["server-fns"].chunks[c].import())[d];let f=[];if(!o||e.method==="GET"){const s=i.searchParams.get("args");if(s){const l=JSON.parse(s);(l.t?I(l,{plugins:[v,$,q,T,H,E,k,C,x,A]}):l).forEach(h=>f.push(h))}}if(e.method==="POST"){const s=t.headers.get("content-type"),l=e.node.req,h=l instanceof ReadableStream,K=l.body instanceof ReadableStream,F=h&&l.locked||K&&l.body.locked,O=h?l:l.body;if(s?.startsWith("multipart/form-data")||s?.startsWith("application/x-www-form-urlencoded"))f.push(await(F?t:new Request(t,{...t,body:O})).formData());else if(s?.startsWith("application/json")){const Q=F?t:new Request(t,{...t,body:O});f=I(await Q.json(),{plugins:[v,$,q,T,H,E,k,C,x,A]})}}try{let s=await D(n,async()=>(X.context={event:n},n.locals.serverFunctionMeta={id:c+"#"+d},p(...f)));if(a&&o&&(s=await B(n,s)),s instanceof Response){if(s.headers&&s.headers.has("X-Content-Raw"))return s;o&&(s.headers&&M(e,s.headers),s.status&&(s.status<300||s.status>=400)&&R(e,s.status),s.customBody?s=await s.customBody():s.body==null&&(s=null))}return o?(y(e,"content-type","text/javascript"),W(o,s)):N(s,t,f)}catch(s){if(s instanceof Response)a&&o&&(s=await B(n,s)),s.headers&&M(e,s.headers),s.status&&(!o||s.status<300||s.status>=400)&&R(e,s.status),s.customBody?s=s.customBody():s.body==null&&(s=null),y(e,"X-Error","true");else if(o){const l=s instanceof Error?s.message:typeof s=="string"?s:"true";y(e,"X-Error",l.replace(/[\r\n]+/g,""))}else s=N(s,t,f,!0);return o?(y(e,"content-type","text/javascript"),W(o,s)):s}}function N(e,n,t,r){const o=new URL(n.url),a=e instanceof Error;let i=302,c;return e instanceof Response?(c=new Headers(e.headers),e.headers.has("Location")&&(c.set("Location",new URL(e.headers.get("Location"),o.origin+"").toString()),i=rt(e))):c=new Headers({Location:new URL(n.headers.get("referer")).toString()}),e&&c.append("Set-Cookie",`flash=${encodeURIComponent(JSON.stringify({url:o.pathname+o.search,result:a?e.message:e,thrown:r,error:a,input:[...t.slice(0,-1),[...t[t.length-1].entries()]]}))}; Secure; HttpOnly;`),new Response(null,{status:i,headers:c})}let b;function it(e){const n=new Headers(e.request.headers),t=Ae(e.nativeEvent),r=e.response.headers.getSetCookie();n.delete("cookie");let o=!1;return e.nativeEvent.node?.req&&(o=!0,e.nativeEvent.node.req.headers.cookie=""),r.forEach(a=>{if(!a)return;const i=a.split(";")[0],[c,d]=i.split("=");c&&d&&(t[c]=d)}),Object.entries(t).forEach(([a,i])=>{n.append("cookie",`${a}=${i}`),o&&(e.nativeEvent.node.req.headers.cookie+=`${a}=${i};`)}),n}async function B(e,n){let t,r=new URL(e.request.headers.get("referer")).toString();n instanceof Response&&(n.headers.has("X-Revalidate")&&(t=n.headers.get("X-Revalidate").split(",")),n.headers.has("Location")&&(r=new URL(n.headers.get("Location"),new URL(e.request.url).origin+"").toString()));const o=Ne(e);return o.request=new Request(r,{headers:it(e)}),await D(o,async()=>{await nt(o),b||(b=(await import("./app.mjs")).default),o.router.dataOnly=t||!0,o.router.previousUrl=e.request.headers.get("referer");try{re(()=>{X.context.event=o,b()})}catch(c){console.log(c)}const a=o.router.data;if(!a)return n;let i=!1;for(const c in a)a[c]===void 0?delete a[c]:i=!0;return i&&(n instanceof Response?n.customBody&&(a._$value=n.customBody()):(a._$value=n,n=new Response(null,{status:200})),n.customBody=()=>a,n.headers.set("X-Single-Flight","true")),n})}const yt=we(at);export{yt as default};
